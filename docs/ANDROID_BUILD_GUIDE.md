# 📱 Android 编译和测试指南

## 当前状态

✅ **方案 A 已完成**: 预设 15 个日文句子，可以在界面上选择和合成

### 已实现的功能
- ✅ 日文句子选择器（Spinner）
- ✅ 15 个常用日文句子
- ✅ 自动音素转换（预先转换好）
- ✅ 真实语音嵌入（jf_nezumi 女声）
- ✅ INT8 量化模型（109MB）

### 可用的日文句子
1. こんにちは (你好)
2. ありがとう (谢谢)
3. さようなら (再见)
4. おはよう (早上好)
5. こんばんは (晚上好)
6. すみません (对不起)
7. はい (是)
8. いいえ (不)
9. おいしい (好吃)
10. きれい (漂亮)
11. わかりました (我明白了)
12. どういたしまして (不客气)
13. お元気ですか (你好吗)
14. 大丈夫です (没关系)
15. 頑張って (加油)

## 🚀 编译和运行步骤

### 1. 在 Android Studio 中打开项目

```bash
# 在项目根目录
File -> Open -> 选择 e:\development\kokoro-ja-demo
```

### 2. 同步 Gradle

Android Studio 会自动提示同步，或者：
- 点击工具栏的 🐘 图标
- 或 File -> Sync Project with Gradle Files

### 3. 连接设备

**方式 A: 真机测试（推荐）**
```
1. 手机开启开发者选项
2. 启用 USB 调试
3. 连接电脑
4. 允许 USB 调试授权
```

**方式 B: 模拟器**
```
1. Tools -> Device Manager
2. 创建虚拟设备（推荐 Pixel 7, API 33+）
3. 启动模拟器
```

### 4. 运行应用

点击绿色的 Run 按钮 ▶️ 或按 `Shift + F10`

## 🧪 测试流程

### 预期行为

1. **启动阶段** (~2-3秒)
   ```
   显示: "正在加载模型..."
   → "这可能需要几秒钟"
   ```

2. **加载完成**
   ```
   显示: "✅ 模型加载成功"
   → "选择一句日文，点击合成"
   按钮: "合成语音" 变为可点击
   ```

3. **选择句子**
   ```
   下拉选择框显示:
   - こんにちは (你好)
   - ありがとう (谢谢)
   - ... 等 15 个选项
   ```

4. **合成语音**
   ```
   点击 "合成语音" 按钮
   
   显示: "正在合成..."
   → "日文: こんにちは"
   → "意思: 你好"
   → "音素: koɲɲiʨiβa"
   
   合成完成:
   → "✅ 合成成功!"
   → "时长: 1.7秒"
   → "正在播放..."
   
   播放完成:
   → "✅ 播放完成!"
   → "可以选择其他句子继续测试"
   ```

5. **听到语音**
   - 清晰的日语女声
   - 说出选择的句子
   - 音质应该很好，不是噪音

## 📊 性能参考

### 预期性能指标

| 阶段 | 时间 | 说明 |
|------|------|------|
| 模型加载 | 1-3s | 首次启动时 |
| 音素转换 | <0.01s | 预先转换，即时 |
| ONNX 推理 | 0.5-2s | 取决于设备 |
| 音频播放 | 1-2s | 句子实际时长 |

### 设备性能

| 设备类型 | 总耗时 | 体验 |
|---------|--------|------|
| 高端 (Pixel 7+) | ~1s | 流畅 ⭐⭐⭐⭐⭐ |
| 中端 (Redmi Note) | ~2s | 良好 ⭐⭐⭐⭐ |
| 低端/模拟器 | ~5s | 可接受 ⭐⭐⭐ |

## 🐛 问题排查

### ❌ 编译错误

**症状**: Gradle sync 失败

**解决**:
1. 检查 Android Studio 版本（推荐 Hedgehog 2023.1+）
2. 检查 JDK 版本（需要 JDK 17+）
3. 清理重建: Build -> Clean Project -> Rebuild Project

### ❌ 模型加载失败

**症状**: "❌ 模型加载失败"

**检查**:
```bash
# 确认 assets 文件存在
ls -lh app/src/main/assets/
# 应该看到:
# kokoro_latest_int8.onnx (109MB)
# jf_nezumi.bin (1KB)
```

**解决**: 如果缺失，重新复制：
```bash
cp kokoro_latest_int8.onnx app/src/main/assets/
```

### ❌ 合成失败

**症状**: "❌ 合成失败"

**检查 Logcat**:
```
Android Studio -> Logcat -> 搜索 "kokoro"
查看详细错误信息
```

**常见原因**:
1. 内存不足（需要 ~200MB 可用内存）
2. ONNX Runtime 初始化失败
3. 语音嵌入加载失败

### ❌ 没有声音

**症状**: 合成成功但听不到声音

**检查**:
1. 设备音量是否打开
2. 是否静音模式
3. 耳机是否正常
4. 查看 Logcat 音频播放错误

## 📝 下一步计划

### 🎯 方案 C: 完整离线 G2P（计划中）

需要实现：
1. **MeCab Android 移植**
   - 编译 MeCab C++ 库为 Android .so
   - 打包 UniDic 词典（~50MB）
   - JNI 接口封装

2. **Cutlet/Misaki 移植**
   - 罗马音转音素规则
   - 可能需要重写为 Kotlin

3. **集成到 App**
   - 添加文本输入框
   - 实时 G2P 转换
   - 支持任意日文文本

**预计工作量**: 2-3 天

## 📦 APK 信息

### Debug APK
- **路径**: `app/build/outputs/apk/debug/app-debug.apk`
- **大小**: ~115MB (包含 109MB 模型)
- **最小 SDK**: API 24 (Android 7.0)
- **目标 SDK**: API 34 (Android 14)

### 生成命令
```bash
# Windows
.\gradlew assembleDebug

# Linux/Mac
./gradlew assembleDebug
```

## ✅ 测试检查清单

- [ ] 应用启动成功
- [ ] 模型加载成功（显示绿色 ✅）
- [ ] 能看到 15 个日文句子
- [ ] 能选择不同的句子
- [ ] 点击"合成语音"按钮工作
- [ ] 能听到清晰的日语女声
- [ ] 每个句子都能正常合成
- [ ] 可以连续合成多个句子
- [ ] 没有崩溃或 ANR
- [ ] 内存占用正常（<200MB）

---

✅ **准备就绪！现在可以在 Android Studio 中编译和运行了！**
