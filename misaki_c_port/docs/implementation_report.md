# 词性转移规则实现报告

## ✅ 已完成的工作

### 1. 创建词性转移规则模块

**文件**:
- `include/misaki_transition_rules.h`
- `src/core/misaki_transition_rules.c`

**实现的规则** (共 9 条):

| 规则 | 词性组合 | 成本调整 | 示例 | 优先级 |
|------|---------|---------|------|--------|
| 1 | 動詞 + 助動詞 | -10.0 | なり + たい | ⭐⭐⭐⭐⭐ |
| 2 | 動詞 + 助詞 | -8.0 | 思っ + て | ⭐⭐⭐⭐⭐ |
| 3 | 助動詞 + 助動詞 | -12.0 | い + ました | ⭐⭐⭐⭐⭐ |
| 4 | 助動詞 + 助詞 | -9.0 | まし + た | ⭐⭐⭐⭐ |
| 5 | 名詞 + 助詞 | -3.0 | 友達 + と | ⭐⭐⭐ |
| 6 | 形容詞 + 名詞 | -4.0 | 新しい + カフェ | ⭐⭐⭐ |
| 7 | 接頭辞/接尾辞 + 名詞 | -2.0 | - | ⭐⭐ |
| 8 | 名詞 + 名詞 | +3.0 | 避免过度复合 | ⭐⭐ |
| 9 | 接尾辞 + 助動詞 | -7.0 | り + たい | ⭐⭐⭐ |

### 2. 集成到分词器

**修改文件**: `src/core/misaki_tokenizer_ja.c`

**关键代码**:
```c
// 在边连接时添加词性转移成本
double trans_cost = misaki_get_transition_cost(from->feature, to->feature);
misaki_lattice_add_edge(from, to, trans_cost);
```

### 3. 更新构建配置

**修改文件**: `CMakeLists.txt`
- 添加 `misaki_transition_rules.c` 到源文件列表
- ✅ 编译成功

---

## 📊 测试结果

### 测试用例 1: 简单句子 ✅

**输入**: `私は学生です`

**结果**: 
```
G2P Result (4 tokens):
  [0] "私" → βatakɯɕi (代名詞)
  [1] "は" → βa (助詞)
  [2] "学生" → ɡakɯseː (名詞)
  [3] "です" → desɨ (助動詞)
```

**评价**: ⭐⭐⭐⭐⭐ 完美！
- 名詞 + 助詞：正确
- 名詞 + 助動詞：正确
- 所有词都是完整的

### 测试用例 2: 复杂句子 ⚠️

**输入**: `昨日、新しいカフェで友達と久しぶりに会って、美味しいケーキを食べながら二時間も喋りました。`

**结果**: 34 tokens

**问题分析**:

| 原文 | 实际分词 | 期望 | 问题原因 |
|------|---------|------|---------|
| 友達 | 友 + 達 | 友達 | 词典有"友達"，但接尾辞规则干扰 |
| 久しぶり | 久 + し + ぶ + り | 久しぶり | ❌ 词典缺失 |
| 会って | 会 + って | 会って | ❌ 词典缺失（动词活用） |
| 美味しい | 美味 + し + い | 美味しい | 词典有"美味しい"，但被拆分 |
| 食べながら | 食 + べ + な + が + ら | 食べながら | ❌ 词典缺失（动词活用） |
| 二時間 | 二 + 時 + 間 | 二時間 | 可能可以合并 |
| 喋りました | 喋り + まし + た | 喋りました | 部分正确（まし+た合并了） |

### 测试用例 3: 另一个复杂句子 ⚠️

**输入**: `子供の頃、宇宙飛行士になりたいと思っていました。`

**结果**: 19 tokens

**问题分析**:

| 原文 | 实际分词 | 期望 | 问题原因 |
|------|---------|------|---------|
| 子供 | 子供 | 子供 | ✅ 正确 |
| 宇宙飛行士 | 宇宙 + 飛 + 行 + 士 | 宇宙飛行士 | ❌ 词典缺失 |
| なりたい | な + り + たい | なりたい | 部分正确（助動詞识别） |
| 思って | 思 + って | 思って | ❌ 词典缺失 |
| いました | い + まし + た | いました | 部分正确（助動詞识别） |

---

## 🎯 核心问题分析

### 问题 1: 词典覆盖不完整 ⭐⭐⭐⭐⭐ (最严重)

**缺失的词汇类型**:
1. **动词活用形式**: 
   - 词典只有基本形：`会う`, `思う`, `食べる`
   - 缺少活用形：`会って`, `思って`, `食べながら`
   
2. **复合名词**:
   - 缺少：`宇宙飛行士`, `久しぶり`
   
3. **助动词变形**:
   - `いました` 被拆成 `い + まし + た`

**影响**: 即使规则再强，词典里没有的词也无法正确分词

### 问题 2: 规则强度平衡 ⭐⭐⭐

**发现**:
- 接尾辞规则（-2.0）仍然导致"友達"被拆分
- 需要更细致的调整

**解决方案**: 
- 降低接尾辞规则强度
- 或者增加词典频率权重

### 问题 3: 长度奖励 vs 词性规则的冲突 ⭐⭐

**当前设置**:
- 长度奖励：`(word_char_len - 1) * 10.0`
- 词性转移：`-12.0` 到 `+3.0`

**问题**: 
- 对于 3-4 个字符的词，长度奖励可能达到 20-30
- 词性转移的影响相对较小

---

## 💡 改进建议

### 短期方案（立即可行）⭐⭐⭐⭐⭐

#### 1. 调整规则强度
```c
// 进一步降低接尾辞规则
if (is_noun_tag(left_tag) && is_suffix_tag(right_tag)) {
    return +0.5;  // 轻微惩罚，而不是鼓励
}
```

#### 2. 增加特殊规则
```c
// 对于形容词，强制保持完整
if (is_adjective_tag(left_tag)) {
    // 形容词通常不应该被拆分
    return +5.0;  // 惩罚任何试图拆分形容词的行为
}
```

### 中期方案（需要一些工作）⭐⭐⭐⭐

#### 1. 扩充词典（限制性的）
虽然无法从 UniDic 提取更多词，但可以：
- **手动添加常用复合词**（100-200 个）
  - 宇宙飛行士, 久しぶり, 電子メール 等
- **添加常用动词活用形**（~500 个）
  - 会って, 思って, 食べながら 等

#### 2. 实现简单的活用识别
```c
// 识别常见的动词活用后缀
if (ends_with(word, "って") || ends_with(word, "ながら") || ends_with(word, "たい")) {
    // 尝试查找词干
    char stem[256];
    extract_stem(word, stem);
    if (dict_contains(stem)) {
        // 允许这个活用形式
        cost -= 5.0;
    }
}
```

### 长期方案（如果需要）⭐⭐

#### 1. 实现方案 3（简化矩阵）
- 提取 top 100 词性的转移成本
- 文件大小：~25 KB
- 预期提升：2-5 tokens

---

## 📈 效果评估

### 当前状态

| 指标 | 无规则 | 有规则 | 改善 |
|-----|--------|--------|------|
| 简单句 (私は学生です) | 4 tokens | 4 tokens | ✅ 保持 |
| 中等句 (新しいカフェ) | 27 tokens | 27 tokens | - 持平 |
| 复杂句 (昨日、新...) | 27 tokens | 34 tokens | ❌ 变差 |

**结论**: 
- ✅ **规则实现成功**
- ⚠️ **但词典覆盖是瓶颈**
- ❌ **接尾辞规则过强，导致反效果**

###继续优化的价值

**值得继续的理由**:
1. 对于词典完整的句子，效果完美
2. 规则框架已经搭好，易于调整
3. 只需微调参数 + 补充少量词汇

**不值得继续的理由**:
1. 词典缺失是根本问题
2. 没有动词活用识别，效果有限
3. 投入产出比可能不高

---

## 🎯 最终建议

### 建议 A: 微调参数 + 少量补充词汇 ⭐⭐⭐⭐⭐

**时间**: 2-3 小时

**工作**:
1. 调整接尾辞规则为惩罚（+0.5）
2. 手动添加 50-100 个常用复合词
3. 添加 100 个常用动词活用形

**预期效果**:
- 简单句：完美（4 tokens）
- 复杂句：20-25 tokens（改善 25-35%）

### 建议 B: 接受现状，标注为"已知限制" ⭐⭐⭐

**理由**:
- 当前效果对于 TTS 已经够用
- 词典限制是外部因素
- 完美分词需要完整的 MeCab

**文档化限制**:
```markdown
## 已知限制
- 动词活用形式可能被拆分（如"会って" → "会" + "って"）
- 未收录的复合名词会被拆分（如"宇宙飛行士"）
- 建议：使用常见词汇可获得最佳效果
```

### 建议 C: 实现简单的后处理规则 ⭐⭐⭐⭐

**时间**: 3-4 小时

**思路**: 在分词结果上应用规则
```c
// 后处理：合并明显的错误拆分
if (token[i].pos == "名詞" && token[i+1].pos == "接尾辞") {
    merge_tokens(i, i+1);
}
if (token[i].pos == "動詞" && token[i+1].text == "って") {
    merge_tokens(i, i+1);
}
```

---

## 💬 总结

**实现成果**: ✅ 词性转移规则框架完成，编译运行正常

**实际效果**: ⚠️ 受词典限制，改善有限

**下一步选择**:
1. **如果追求完美** → 建议 A（微调 + 补词）
2. **如果够用就好** → 建议 B（接受现状）
3. **如果想快速改善** → 建议 C（后处理）

**我的推荐**: **建议 A**，因为只需 2-3 小时，投入小，见效明显！🚀
