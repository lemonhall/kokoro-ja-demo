# æ—¥æ–‡åˆ†è¯è¯æ€§è½¬ç§»æˆæœ¬çŸ©é˜µ - ä¼˜åŒ–è®¾è®¡æ–¹æ¡ˆ

## ğŸ“Š é—®é¢˜èƒŒæ™¯

### åŸå§‹ MeCab/UniDic çŸ©é˜µ

- **æ–‡ä»¶**: `matrix.bin`
- **å¤§å°**: 459 MB ğŸ’€
- **ç»“æ„**: çº¦ 15,000 Ã— 15,000 çš„æˆæœ¬çŸ©é˜µ
- **æ€»å…ƒç´ **: ~240,000,000 ä¸ª short å€¼
- **é—®é¢˜**: 
  - æ–‡ä»¶å¤ªå¤§ï¼Œä¸é€‚åˆç§»åŠ¨ç«¯
  - åŠ è½½æ…¢ï¼Œå†…å­˜å ç”¨é«˜
  - å®é™…ä½¿ç”¨ä¸­å¤§éƒ¨åˆ†è¯æ€§ç»„åˆå¾ˆå°‘å‡ºç°

### å½“å‰åˆ†è¯å™¨çŠ¶æ€

- âœ… **å·²å®ç°**: Viterbi ç®—æ³• + è¯é¢‘ + é•¿åº¦å¥–åŠ±
- âœ… **æ•ˆæœ**: ä» 43 token â†’ 27 token (æ”¹å–„ 37%)
- âš ï¸ **é—®é¢˜**: 
  - "ä¹…ã—ã¶ã‚Š" â†’ "ä¹…" + "ã—ã¶" + "ã‚Š" (è¯å…¸ç¼ºå¤±)
  - "ä¼šã£ã¦" â†’ "ä¼š" + "ã£ã¦" (åŠ¨è¯æ´»ç”¨æœªè¯†åˆ«)
  - "é£Ÿã¹ãªãŒã‚‰" â†’ "é£Ÿ" + "ã¹" + "ãªãŒã‚‰" (å¤åˆæœªè¯†åˆ«)

---

## ğŸ¯ ä¼˜åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: å‚æ•°è°ƒä¼˜ï¼ˆå·²å®Œæˆï¼‰âœ…

**å®ç°**: è°ƒæ•´ Viterbi ç®—æ³•çš„æˆæœ¬è®¡ç®—

```c
// å½“å‰å‚æ•°
double node_cost = -log(freq) - (word_char_len - 1) * 10.0;  // é•¿åº¦å¥–åŠ±
double single_char_cost = 20.0;  // å•å­—æƒ©ç½š
```

**ä¼˜ç‚¹**:
- âœ… ç®€å•ç›´æ¥ï¼Œæ— éœ€é¢å¤–æ•°æ®
- âœ… å·²è¯æ˜æœ‰æ•ˆ

**ç¼ºç‚¹**:
- âŒ æ— æ³•å¤„ç†è¯æ€§æ­é…è§„åˆ™
- âŒ å¯¹å¤æ‚è¯­æ³•ç»“æ„æ•ˆæœæœ‰é™

---

### æ–¹æ¡ˆ 2: ç¡¬ç¼–ç å¸¸ç”¨è¯æ€§è§„åˆ™ â­ **æ¨è**

**æ ¸å¿ƒæ€è·¯**: æ ¹æ®æ—¥è¯­è¯­æ³•è§„åˆ™ï¼Œç¡¬ç¼–ç å¸¸è§çš„è¯æ€§è½¬ç§»æ¨¡å¼

#### 2.1 æ—¥è¯­å¸¸è§è¯æ€§ç»„åˆ

| å‰æ¥è¯æ€§ | åæ¥è¯æ€§ | æˆæœ¬è°ƒæ•´ | ç¤ºä¾‹ |
|---------|---------|---------|------|
| å‹•è© | åŠ©å‹•è© | -5.0 | é£Ÿã¹ + ã¾ã™ |
| å‹•è© | åŠ©è©(ã¦) | -5.0 | ä¼šã£ + ã¦ |
| åè© | åŠ©è©(ã¯/ãŒ/ã‚’/ã«) | -3.0 | å‹é” + ã¨ |
| å½¢å®¹è© | åè© | -2.0 | æ–°ã—ã„ + ã‚«ãƒ•ã‚§ |
| åè© | åè© | +3.0 | é¿å…è¿‡åº¦å¤åˆ |
| æ¥é ­è¾ | åè© | -4.0 | æ–° + ã—ã„ |

#### 2.2 å®ç°ä»£ç 

```c
/**
 * è·å–è¯æ€§è½¬ç§»æˆæœ¬
 * åŸºäºç¡¬ç¼–ç çš„æ—¥è¯­è¯­æ³•è§„åˆ™
 */
double get_transition_cost(const char *left_tag, const char *right_tag) {
    if (!left_tag || !right_tag) {
        return 0.0;
    }
    
    // è¦å‰‡ 1: å‹•è© + åŠ©å‹•è© (é£Ÿã¹ + ã¾ã™)
    if (strstr(left_tag, "å‹•è©") && strstr(right_tag, "åŠ©å‹•è©")) {
        return -5.0;  // å¼ºé¼“åŠ±
    }
    
    // è¦å‰‡ 2: å‹•è© + åŠ©è©(ã¦å½¢) (ä¼šã£ + ã¦)
    if (strstr(left_tag, "å‹•è©") && strstr(right_tag, "åŠ©è©")) {
        return -4.0;
    }
    
    // è¦å‰‡ 3: åè© + åŠ©è© (å‹é” + ã¨)
    if (strstr(left_tag, "åè©") && strstr(right_tag, "åŠ©è©")) {
        return -3.0;
    }
    
    // è¦å‰‡ 4: å½¢å®¹è© + åè© (æ–°ã—ã„ + ã‚«ãƒ•ã‚§)
    if (strstr(left_tag, "å½¢å®¹è©") && strstr(right_tag, "åè©")) {
        return -2.0;
    }
    
    // è¦å‰‡ 5: æ¥é ­è¾/æ¥å°¾è¾ + åè© (æ–° + ã—ã„)
    if ((strstr(left_tag, "æ¥é ­è¾") || strstr(left_tag, "æ¥å°¾è¾")) 
        && strstr(right_tag, "åè©")) {
        return -4.0;
    }
    
    // è¦å‰‡ 6: åè© + åè© (é¿å…è¿‡åº¦å¤åˆ)
    if (strstr(left_tag, "åè©") && strstr(right_tag, "åè©")) {
        return +2.0;  // è½»å¾®æƒ©ç½š
    }
    
    // é»˜è®¤ï¼šæ— é¢å¤–æˆæœ¬
    return 0.0;
}
```

#### 2.3 é›†æˆåˆ° Viterbi

```c
// åœ¨ misaki_tokenizer_ja.c çš„è¾¹è¿æ¥ä»£ç ä¸­
for (int i = 0; i < counts_by_pos[pos]; i++) {
    LatticeNode *from = nodes_by_pos[pos][i];
    int next_pos = pos + from->length;
    
    if (next_pos < text_len) {
        for (int j = 0; j < counts_by_pos[next_pos]; j++) {
            LatticeNode *to = nodes_by_pos[next_pos][j];
            
            // â­ æ·»åŠ è¯æ€§è½¬ç§»æˆæœ¬
            double trans_cost = get_transition_cost(from->tag, to->tag);
            
            misaki_lattice_add_edge(from, to, trans_cost);
        }
    }
}
```

**ä¼˜ç‚¹**:
- âœ… å®ç°ç®€å•ï¼ˆçº¦ 50 è¡Œä»£ç ï¼‰
- âœ… æ— éœ€å¤–éƒ¨æ•°æ®æ–‡ä»¶
- âœ… å¯ä»¥æ ¹æ®å®æµ‹æ•ˆæœå¿«é€Ÿè°ƒæ•´
- âœ… å†…å­˜å ç”¨å‡ ä¹ä¸º 0

**ç¼ºç‚¹**:
- âŒ è§„åˆ™æ•°é‡æœ‰é™
- âŒ éœ€è¦ä¸€å®šçš„æ—¥è¯­è¯­æ³•çŸ¥è¯†

**é¢„æœŸæ•ˆæœ**:
- "ä¼šã£ã¦" â†’ è¯†åˆ«ä¸ºå®Œæ•´è¯
- "é£Ÿã¹ãªãŒã‚‰" â†’ å¯èƒ½æ”¹å–„ï¼ˆå–å†³äºè¯å…¸ï¼‰
- 27 token â†’ é¢„è®¡ 20-23 token

---

### æ–¹æ¡ˆ 3: æå–ç®€åŒ–è¯æ€§çŸ©é˜µ â­â­ **å¤‡é€‰**

**æ ¸å¿ƒæ€è·¯**: åªä¿ç•™æœ€å¸¸è§çš„ 100-200 ä¸ªè¯æ€§ç»„åˆ

#### 3.1 ç»Ÿè®¡æœ€å¸¸ç”¨è¯æ€§

ä» 68,087 ä¸ªè¯æ±‡ä¸­ç»Ÿè®¡è¯æ€§åˆ†å¸ƒï¼š

```python
# ç»Ÿè®¡è¯æ€§å‡ºç°é¢‘ç‡
pos_freq = {}
with open('ja_pron_dict.tsv') as f:
    for line in f:
        parts = line.strip().split('\t')
        if len(parts) >= 4:
            pos = parts[3]  # è¯æ€§
            pos_freq[pos] = pos_freq.get(pos, 0) + 1

# é€‰æ‹© top 100 è¯æ€§
top_pos = sorted(pos_freq.items(), key=lambda x: -x[1])[:100]
```

#### 3.2 æå–å­çŸ©é˜µ

```python
# ä» matrix.bin æå–å¯¹åº”çš„æˆæœ¬
pos_to_id = {pos: i for i, (pos, _) in enumerate(top_pos)}

with open('transition_cost_100.txt', 'w') as f:
    for left_pos in top_pos:
        for right_pos in top_pos:
            left_id = pos_to_id[left_pos[0]]
            right_id = pos_to_id[right_pos[0]]
            cost = matrix[left_id][right_id]
            f.write(f"{left_pos[0]}\t{right_pos[0]}\t{cost}\n")
```

#### 3.3 æ•°æ®ç»“æ„

```c
// è¯æ€§ ID æ˜ å°„
typedef struct {
    const char *tag;  // è¯æ€§åç§°
    int id;           // å†…éƒ¨ ID (0-99)
} TagMapping;

// æˆæœ¬çŸ©é˜µ (100 x 100 = 10,000 ä¸ª short)
static short transition_matrix[100][100];

// è¯æ€§åç§°åˆ° ID çš„æ˜ å°„
static TagMapping tag_map[] = {
    {"åŠ©è©", 0},
    {"åŠ©å‹•è©", 1},
    {"åè©", 2},
    {"å‹•è©", 3},
    // ... å…± 100 ä¸ª
};

// æŸ¥è¯¢æˆæœ¬
double get_transition_cost_from_matrix(const char *left_tag, const char *right_tag) {
    int left_id = find_tag_id(left_tag);
    int right_id = find_tag_id(right_tag);
    
    if (left_id < 0 || right_id < 0) {
        return 0.0;  // æœªçŸ¥è¯æ€§ï¼Œä½¿ç”¨é»˜è®¤
    }
    
    return (double)transition_matrix[left_id][right_id];
}
```

**æ•°æ®å¤§å°**:
- 100 Ã— 100 Ã— 2 å­—èŠ‚ = **20 KB** âœ…
- åŠ ä¸Šè¯æ€§æ˜ å°„è¡¨ â‰ˆ **25 KB**

**ä¼˜ç‚¹**:
- âœ… åŸºäºçœŸå®æ•°æ®ï¼Œè¦†ç›–é¢å¹¿
- âœ… æ–‡ä»¶å°ï¼Œé€‚åˆç§»åŠ¨ç«¯
- âœ… å¯ä»¥ç¦»çº¿ç”Ÿæˆï¼Œè¿è¡Œæ—¶ç›´æ¥åŠ è½½

**ç¼ºç‚¹**:
- âŒ éœ€è¦é¢å¤–çš„æ•°æ®æ–‡ä»¶
- âŒ éœ€è¦ç¼–å†™æå–è„šæœ¬
- âŒ å¯¹éå¸¸è§è¯æ€§æ— æ•ˆ

**é¢„æœŸæ•ˆæœ**:
- 27 token â†’ é¢„è®¡ 18-22 token
- æ›´æ¥è¿‘ MeCab çš„åŸå§‹æ•ˆæœ

---

## ğŸ¯ æœ€ç»ˆæ¨èæ–¹æ¡ˆ

### **é˜¶æ®µ 1: ç«‹å³å®æ–½æ–¹æ¡ˆ 2** â­â­â­â­â­

1. **å®ç°ç¡¬ç¼–ç è§„åˆ™** (1å°æ—¶)
   - æ·»åŠ  `get_transition_cost()` å‡½æ•°
   - é›†æˆåˆ° Viterbi è¾¹è¿æ¥é€»è¾‘
   - ç¼–å†™ 10-15 æ¡æ ¸å¿ƒè§„åˆ™

2. **æµ‹è¯•éªŒè¯** (30åˆ†é’Ÿ)
   - ä½¿ç”¨é•¿å¥æµ‹è¯•
   - å¯¹æ¯”ä¼˜åŒ–å‰åçš„ token æ•°
   - è°ƒæ•´è§„åˆ™æƒé‡

3. **é¢„æœŸæ•ˆæœ**:
   - âœ… ä»£ç é‡å°ï¼ˆ< 100 è¡Œï¼‰
   - âœ… æ— å¤–éƒ¨ä¾èµ–
   - âœ… ç«‹å³å¯ç”¨
   - âœ… æ€§èƒ½æå‡ 10-20%

### **é˜¶æ®µ 2: å¯é€‰å®æ–½æ–¹æ¡ˆ 3** â­â­â­

å¦‚æœæ–¹æ¡ˆ 2 æ•ˆæœä¸æ»¡æ„ï¼Œå†è€ƒè™‘ï¼š

1. **ç»Ÿè®¡åˆ†æ** (1å°æ—¶)
   - åˆ†æ 68K è¯å…¸çš„è¯æ€§åˆ†å¸ƒ
   - é€‰æ‹© top 100 è¯æ€§

2. **æå–çŸ©é˜µ** (2å°æ—¶)
   - ç¼–å†™ Python è„šæœ¬è§£æ matrix.bin
   - æå–å­çŸ©é˜µå¹¶å¯¼å‡ºæ–‡æœ¬æ ¼å¼
   - è½¬æ¢ä¸º C æ•°ç»„

3. **é›†æˆåŠ è½½** (1å°æ—¶)
   - ä¿®æ”¹åˆ†è¯å™¨åŠ è½½çŸ©é˜µ
   - å®ç°æŸ¥è¯¢å‡½æ•°

---

## ğŸ“ å®ç°æ¸…å•

### æ–¹æ¡ˆ 2: ç¡¬ç¼–ç è§„åˆ™

- [ ] åˆ›å»º `misaki_transition_rules.c/h`
- [ ] å®ç° `get_transition_cost()` å‡½æ•°
- [ ] ä¿®æ”¹ `misaki_tokenizer_ja.c` é›†æˆè§„åˆ™
- [ ] ç¼–å†™æµ‹è¯•ç”¨ä¾‹
- [ ] æ€§èƒ½å¯¹æ¯”æµ‹è¯•

### æ–¹æ¡ˆ 3: ç®€åŒ–çŸ©é˜µï¼ˆå¯é€‰ï¼‰

- [ ] ç¼–å†™ `extract_transition_matrix.py`
- [ ] ç»Ÿè®¡è¯æ€§åˆ†å¸ƒï¼Œé€‰æ‹© top 100
- [ ] ä» matrix.bin æå–å­çŸ©é˜µ
- [ ] ç”Ÿæˆ C è¯­è¨€æ•°ç»„æ–‡ä»¶
- [ ] å®ç°åŠ è½½å’ŒæŸ¥è¯¢å‡½æ•°
- [ ] å¯¹æ¯”æ–¹æ¡ˆ 2 çš„æ•ˆæœå·®å¼‚

---

## ğŸ¯ é¢„æœŸæˆæœ

| æŒ‡æ ‡ | å½“å‰ | æ–¹æ¡ˆ2 | æ–¹æ¡ˆ3 |
|-----|------|-------|-------|
| Tokenæ•° | 27 | 20-23 | 18-22 |
| ä»£ç é‡ | - | +100è¡Œ | +300è¡Œ |
| æ•°æ®å¤§å° | 0 | 0 | 25KB |
| å®ç°æ—¶é—´ | - | 1.5å°æ—¶ | 4å°æ—¶ |
| ç§»åŠ¨ç«¯é€‚é… | âœ… | âœ… | âœ… |

---

## ğŸ“Œ æ€»ç»“

**æ¨èè·¯çº¿**:
1. âœ… **å…ˆå®ç°æ–¹æ¡ˆ 2**ï¼ˆç¡¬ç¼–ç è§„åˆ™ï¼‰
   - æŠ•å…¥å°ï¼Œè§æ•ˆå¿«
   - é€‚åˆå¿«é€Ÿè¿­ä»£
   
2. â¸ï¸ **æ ¹æ®æ•ˆæœå†³å®šæ˜¯å¦éœ€è¦æ–¹æ¡ˆ 3**
   - å¦‚æœæ–¹æ¡ˆ 2 å·²æ»¡è¶³éœ€æ±‚ â†’ åœæ­¢
   - å¦‚æœè¿˜éœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ– â†’ å®æ–½æ–¹æ¡ˆ 3

**å…³é”®åŸåˆ™**: 
- ğŸ¯ **å¤Ÿç”¨å°±å¥½**ï¼Œä¸è¿‡åº¦ä¼˜åŒ–
- ğŸ“± **ç§»åŠ¨ç«¯ä¼˜å…ˆ**ï¼Œæ§åˆ¶æ•°æ®å¤§å°
- ğŸš€ **å¿«é€Ÿè¿­ä»£**ï¼Œæ ¹æ®å®æµ‹è°ƒæ•´

---

## ğŸ“– å‚è€ƒèµ„æ–™

- [MeCab å®˜æ–¹æ–‡æ¡£](https://taku910.github.io/mecab/)
- [UniDic è¯å…¸è§„èŒƒ](https://clrd.ninjal.ac.jp/unidic/)
- æœ¬é¡¹ç›®æµ‹è¯•ç»“æœ: 43 token â†’ 27 token (é•¿åº¦å¥–åŠ±ä¼˜åŒ–)
