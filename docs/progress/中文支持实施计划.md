# Kokoro Android 中文支持实施计划

> 📅 创建时间: 2025-10-25  
> 🎯 目标: 在 Android 应用中添加中文语音合成支持  
> 🔗 项目地址: https://github.com/lemonhall/kokoro-ja-demo

---

## 📋 核心发现

通过测试 `zh.py`，我们确认了:

✅ **模型无需改动** - Kokoro-82M 模型本身是多语言通用的  
✅ **语音嵌入可复用** - 只需导出 `zf_xiaoxiao` 音色即可  
✅ **核心差异在前处理** - 日语用假名→IPA，中文用拼音→IPA

```
┌─────────────┐      ┌──────────┐      ┌─────────────┐      ┌────────┐
│   输入文本   │  →  │  G2P转换  │  →  │  音素序列    │  →  │ 语音波形│
└─────────────┘      └──────────┘      └─────────────┘      └────────┘
     日语                假名→IPA           kʲoːβa...          同一模型
     中文                拼音→IPA           ni xau...           ✅
```

---

## 🎯 实施路线图

### 阶段 0: 探索与准备 (当前阶段)

**目标**: 理解中文 G2P 转换的完整流程

#### Task 0.1: 分析 misaki[zh] 的实现 ✅
- [x] 查看 `.venv/Lib/site-packages/misaki/zh.py` 源码
- [x] 提取拼音→IPA 的映射规则
- [x] 理解声母、韵母、声调的处理逻辑
- [x] 记录关键数据结构

**输出**: ✅ `misaki中文G2P分析报告.md`

---

#### Task 0.2: 测试 pypinyin 的拼音转换 ✅
- [x] 编写测试脚本 `test_chinese_pinyin.py`
- [x] 测试不同类型的中文句子:
  - 简单句: "你好世界" → `ni3 hao3 shi4 jie4`
  - 多音字: "我行行好吧" → `wo3 xing2 xing2 hao3 ba5`
  - 数字: "2024年10月25日" → 保留数字
  - 混合: "iPhone 15 很贵" → 保留英文
- [x] 记录拼音输出格式

**输出**: ✅ 拼音转换测试结果（已验证）

---

#### Task 0.3: 对比 Python 端完整流程 ✅
- [x] 运行 `zh.py` 并记录每一步的输出:
  ```
  "你好世界" → ni3 hao3 shi4 jie4 → ni↓xau↓ ʂɨ↘ʨje↘
  "中文测试" → zhong1 wen2 ce4 shi4 → ꭧʊ→ŋwə↗n ʦʰɤ↘ʂɨ↘
  ```
- [x] 保存完整的音素输出作为对照基准
- [x] 理解 jieba 分词的作用 (用于英文分割)

**输出**: ✅ Python 端完整转换日志（test_chinese_pinyin.py）

---

### 阶段 1: 导出中文语音资源

**目标**: 准备 Android 端需要的中文音色嵌入

#### Task 1.1: 修改语音导出脚本 ✅
- [x] 创建 `export_chinese_voices.py` (基于日文版本)
- [x] 修改为导出 `zf_xiaoxiao` 音色
- [x] 确认嵌入向量的维度和格式: `[510, 1, 256]` ✅
- [x] 导出为 `app/src/main/assets/voices/zf_xiaoxiao.bin`
- [x] 包含完整 510 帧，支持动态帧选择

**输出**: ✅ `zf_xiaoxiao.bin` (510 KB), `zf_xiaoxiao.npy` (510 KB)

---

#### Task 1.2: 验证语音嵌入可用性 ✅
- [x] Python 端验证成功
- [x] 确认形状: `[510, 256]` ✅ (注意: 是256维，不是512)
- [x] 测试音频生成成功: `test_xiaoxiao.wav` (3.00秒)
- [x] 验证动态帧选择: 34个音素 → 选择第33帧 ✅
- [x] 帧间差异验证: 长句韵律差异明显 ✅

**输出**: ✅ Python端完全验证通过

---

### 阶段 2: 移植中文 G2P 核心逻辑

**目标**: 在 Kotlin 中实现拼音→IPA 转换

#### Task 2.1: 创建拼音→IPA 映射表
- [ ] 创建 `ChinesePinyinToIPA.kt`
- [ ] 移植 misaki 的声母映射表 (21个)
  ```kotlin
  private val initialsMap = mapOf(
      "b" to "p",    // 不送气清塞音
      "p" to "pʰ",   // 送气清塞音
      // ... 完整映射
  )
  ```
- [ ] 移植韵母映射表 (39个)
  ```kotlin
  private val finalsMap = mapOf(
      "a" to "a",
      "ai" to "ai",
      "an" to "an",
      "ang" to "aŋ",
      // ... 完整映射
  )
  ```
- [ ] 实现声调处理逻辑

**输出**: `ChinesePinyinToIPA.kt` 基础框架

---

#### Task 2.2: 实现拼音解析算法
- [ ] 编写拼音切分逻辑 (声母+韵母)
- [ ] 处理特殊情况:
  - 零声母: "an" → "∅an"
  - 儿化音: "haor" → "xauɚ"
  - 轻声: "de" → "də"
- [ ] 参考 OpenJTalkG2P 的实现模式

**输出**: 完整的拼音解析器

---

#### Task 2.3: 单元测试
- [ ] 创建测试用例:
  ```kotlin
  "ni3 hao3" → "ni xau"
  "zhong1 wen2" → "tʂʊŋ wən"
  ```
- [ ] 对比 Python 端输出，确保一致性
- [ ] 测试覆盖率 > 90%

**输出**: 通过的测试用例

---

### 阶段 3: 集成汉字转拼音库

**目标**: 让 Android 应用能够输入汉字

#### Task 3.1: 选择拼音库
- [ ] 评估 TinyPinyin 库:
  - 优点: 轻量、无依赖、快速
  - 缺点: 多音字准确度一般
- [ ] 添加 Gradle 依赖:
  ```kotlin
  implementation("com.github.promeg:tinypinyin:2.0.3")
  ```
- [ ] 测试基本功能

**备选方案**: 如果 TinyPinyin 不满足需求，考虑移植 pypinyin 的词典

---

#### Task 3.2: 创建 ChineseG2PSystem
- [ ] 创建 `ChineseG2PSystem.kt`，参考 `JapaneseG2PSystem.kt` 的结构
- [ ] 实现核心方法:
  ```kotlin
  class ChineseG2PSystem(private val context: Context) {
      fun textToPhonemes(text: String): String {
          // 1. 汉字 → 拼音 (TinyPinyin)
          // 2. 拼音 → IPA (ChinesePinyinToIPA)
          // 3. 返回音素字符串
      }
  }
  ```

**输出**: `ChineseG2PSystem.kt`

---

#### Task 3.3: 端到端测试
- [ ] 测试句子: "中文测试，长句朗读"
- [ ] 对比 Android 输出 vs Python 输出:
  ```
  Python:  tʂʊŋ wən tsʰə ʂɨ tʂaŋ tɕy laŋ tu
  Android: tʂʊŋ wən tsʰə ʂɨ tʂaŋ tɕy laŋ tu
  ```
- [ ] 计算音素准确率

**输出**: G2P 准确率报告

---

### 阶段 4: UI 集成与多语言支持

**目标**: 在现有应用中添加中文语音合成功能

#### Task 4.1: 修改 MainActivity
- [ ] 添加语言选择器 (RadioButton: 日语/中文)
- [ ] 根据语言切换 G2P 系统:
  ```kotlin
  private lateinit var japaneseG2P: JapaneseG2PSystem
  private lateinit var chineseG2P: ChineseG2PSystem
  
  val phonemes = when(selectedLanguage) {
      "ja" -> japaneseG2P.textToPhonemes(text)
      "zh" -> chineseG2P.textToPhonemes(text)
      else -> throw IllegalArgumentException()
  }
  ```
- [ ] 根据语言切换语音嵌入:
  ```kotlin
  val voice = when(selectedLanguage) {
      "ja" -> "jf_nezumi"
      "zh" -> "zf_xiaoxiao"
      else -> throw IllegalArgumentException()
  }
  ```

**输出**: 支持双语言的 UI

---

#### Task 4.2: 添加中文预设句子
- [ ] 创建 `ChinesePresets.kt`
- [ ] 添加 5-10 个中文测试句子:
  ```kotlin
  data class ChineseSentence(
      val text: String,
      val translation: String,
      val phonemes: String  // 预计算的音素
  )
  ```

**输出**: `ChinesePresets.kt`

---

#### Task 4.3: 完整流程测试
- [ ] 测试日语合成 → 正常
- [ ] 测试中文合成 → 正常
- [ ] 测试语言切换 → 正常
- [ ] 性能测试: RTF < 1.0

**输出**: 功能完整的双语 TTS 应用

---

### 阶段 5: 优化与文档

#### Task 5.1: 性能优化
- [ ] 缓存拼音转换结果
- [ ] 优化音素查找算法
- [ ] 减少内存占用

---

#### Task 5.2: 准确度提升
- [ ] 处理多音字 (如果 TinyPinyin 不支持，考虑上下文规则)
- [ ] 处理儿化音
- [ ] 处理轻声

---

#### Task 5.3: 编写文档
- [ ] 更新 `README.md`，添加中文支持说明
- [ ] 创建 `中文G2P技术报告.md`
- [ ] 录制演示视频 (可选)

---

## 📊 技术栈对比

| 组件 | Python 端 | Android 端 | 备注 |
|------|-----------|-----------|------|
| **分词** | jieba | TinyPinyin (内置) | 中文无需显式分词 |
| **汉字→拼音** | pypinyin | TinyPinyin | 轻量级替代方案 |
| **拼音→IPA** | misaki.zh | ChinesePinyinToIPA | 需要移植 |
| **数字转换** | cn2an | (可选) | 后期优化 |
| **模型** | PyTorch | ONNX Runtime | 完全相同 ✅ |
| **音色** | zf_xiaoxiao | zf_xiaoxiao.raw | 格式转换 |

---

## 🚧 已知风险与缓解措施

### 风险 1: TinyPinyin 多音字准确度不足
**影响**: 中等 (部分句子读音错误)  
**缓解**: 
- 先验证常见句子的准确度
- 如不满足，考虑移植 pypinyin 词典 (约 50MB)

### 风险 2: 声调处理复杂
**影响**: 高 (可能影响自然度)  
**缓解**:
- 先实现无声调版本 (验证可行性)
- 后续根据音质决定是否添加声调

### 风险 3: 与 Python 端输出不一致
**影响**: 高 (影响音质)  
**缓解**:
- 在每个阶段都进行对比测试
- 保存 Python 端输出作为 Golden Reference

---

## 📈 预期成果

### 最小可行产品 (MVP)
- ✅ 支持中文文本输入
- ✅ 基本准确的拼音转换 (>80%)
- ✅ 可听懂的语音输出
- ✅ RTF < 1.0 (实时合成)

### 完整版本
- ✅ 多音字正确处理 (>90%)
- ✅ 支持数字、英文混合输入
- ✅ 轻声、儿化音处理
- ✅ 双语言无缝切换

---

## 🎬 下一步行动

### 立即开始: 阶段 0.1
1. 查看 `misaki/zh.py` 源码
2. 提取拼音→IPA 映射表
3. 创建 `misaki中文G2P分析报告.md`

**命令**:
```bash
# 查看 misaki 源码
code .venv/Lib/site-packages/misaki/zh.py

# 或直接读取
cat .venv/Lib/site-packages/misaki/zh.py
```

---

## 📝 开发日志

| 日期 | 阶段 | 完成任务 | 备注 |
|------|------|----------|------|
| 2025-10-25 | 0.0 | 创建实施计划 | - |
| 2025-10-25 | 0.1 | 分析 misaki[zh] 实现 | 21个声母、40个韵母 |
| 2025-10-25 | 0.2 | 测试 pypinyin 转换 | TONE3 格式: ni3 hao3 |
| 2025-10-25 | 0.3 | 对比 Python 完整流程 | 已获取 IPA 基准 |
| 2025-10-25 | 1.1 | 导出中文语音嵌入 | zf_xiaoxiao.bin (510KB) |
| 2025-10-25 | 1.2 | 验证语音嵌入 | 动态帧选择验证通过 |

---

**Let's Go! 🚀**
